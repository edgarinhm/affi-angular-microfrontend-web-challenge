# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  branches:
    include:
      - main
      - feature/*
      - fix/*
  paths:
    include:
      - "mfe-host/*"

variables:
  nodeVersion: "22.x"
  angularCliVersion: "19.2.10"
  npmRegistryURL: "https://registry.npmjs.org/"
  appName: "mfe-host"
  appPath: "projects/mfe-host"
  appArtifactName: "mfe-host"
  appBuildCommandDev: "npm run build:mfe-host -- --configuration=development"
  appBuildCommandProd: "npm run build:mfe-host -- --configuration=production"
  tag: $(Build.BuildId)
  NPM_CACHE_FOLDER: $(Pipeline.Workspace)/.npm

stages:
  - stage: Build
    jobs:
      - job: install_dependencies
        pool:
          vmImage: ubuntu-latest
        steps:
          # Install node
          - task: NodeTool@0
            displayName: "Install Node.js"
            inputs:
              versionSpec: $(nodeVersion)

          - task: Npm@1
            displayName: "Angular CLI ${{ variables.angularCliVersion}}"
            inputs:
              command: custom
              verbose: false
              customCommand: "install -g @angular/cli@${{ variables.angularCliVersion}}"

          # Cache installed npm dependencies
          - task: Cache@2
            displayName: "Cache Npm Dependencies"
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(NPM_CACHE_FOLDER)

          # Install dependencies
          - script: npm clean install
            displayName: "Install dependencies"

          - script: ${{ variables.appBuildCommandProd }}
            displayName: "Build ${{ variables.appName }} Prod"
            env:
              MS_API_URL: $(MS_API_URL)

          # Copy and publish artifact
          - task: CopyPublishBuildArtifacts@1
            displayName: "Copy Publish Artifact: angular-web-${{ variables.appArtifactName }}"
            inputs:
              CopyRoot: /dist
              Contents: "**"
              ArtifactName: angular-web-${{ variables.appArtifactName }}
              ArtifactType: Container
